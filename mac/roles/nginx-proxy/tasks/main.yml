# --------------------------
# Install nginx
# --------------------------
- name: Install nginx (macOS)
  homebrew:
    name: nginx
    state: present
  become: false
  when: ansible_facts['os_family'] == 'Darwin'

- name: Install nginx (Linux)
  apt:
    name: nginx
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Linux'

# --------------------------
# macOS nginx directory setup
# --------------------------
- name: Setup nginx directories (macOS)
  include_tasks: macos-setup.yml
  when: ansible_facts['os_family'] == 'Darwin'

# --------------------------
# Template nginx configs
# --------------------------
- name: Template dashboard config
  template:
    src: dashboard.conf.j2
    dest: "{{ nginx_config_dir }}/sites-available/dashboard.conf"

- name: Template api config
  template:
    src: api.conf.j2
    dest: "{{ nginx_config_dir }}/sites-available/api.conf"

- name: Template reader config
  template:
    src: reader.conf.j2
    dest: "{{ nginx_config_dir }}/sites-available/reader.conf"

- name: Template keycloak config
  template:
    src: keycloak.conf.j2
    dest: "{{ nginx_config_dir }}/sites-available/keycloak.conf"

# --------------------------
# Enable sites
# --------------------------
- name: Enable nginx sites
  file:
    src: "{{ nginx_config_dir }}/sites-available/{{ item }}.conf"
    dest: "{{ nginx_config_dir }}/sites-enabled/{{ item }}.conf"
    state: link
    force: yes
  loop:
    - dashboard
    - api
    - reader
    - keycloak

# --------------------------
# /etc/hosts
# --------------------------
- name: Add hosts entries
  include_tasks: hosts.yml

# --------------------------
# Restart nginx
# --------------------------
# --------------------------
# Validate nginx config
# --------------------------
- name: Validate nginx config (macOS)
  command: nginx -t
  when: ansible_facts['os_family'] == 'Darwin'

# --------------------------
# Reload nginx (macOS)
# --------------------------
- name: Reload nginx (macOS)
  command: nginx -s reload
  when: ansible_facts['os_family'] == 'Darwin'

- name: Restart nginx (Linux)
  service:
    name: nginx
    state: restarted
  when: ansible_facts['os_family'] == 'Linux'

# --------------------------
# Detect Homebrew prefix
# --------------------------
- name: Get brew prefix
  shell: |
    if command -v brew >/dev/null 2>&1; then
      brew --prefix
    elif [ -f /opt/homebrew/bin/brew ]; then
      /opt/homebrew/bin/brew --prefix
    elif [ -f /usr/local/bin/brew ]; then
      /usr/local/bin/brew --prefix
    fi
  register: brew_prefix
  changed_when: false
  become: false

# --------------------------
# Set nginx config directory
# --------------------------
- name: Set nginx config directory (macOS)
  set_fact:
    nginx_config_dir: "{{ brew_prefix.stdout }}/etc/nginx"

# --------------------------
# Create nginx directories
# --------------------------
- name: Create nginx directories (macOS)
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ nginx_config_dir }}/sites-available"
    - "{{ nginx_config_dir }}/sites-enabled"

# --------------------------
# Ensure nginx.conf includes sites-enabled
# --------------------------
- name: Ensure nginx.conf includes sites-enabled
  lineinfile:
    path: "{{ nginx_config_dir }}/nginx.conf"
    regexp: "sites-enabled/\\*"
    insertafter: "http {"
    line: "    include {{ nginx_config_dir }}/sites-enabled/*;"

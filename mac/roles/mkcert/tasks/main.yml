# --------------------------
# Validate input
# --------------------------
- name: Assert magazine provided
  assert:
    that:
      - magazine | length > 0
    fail_msg: "Pass magazine=yourdomain.magsquare.com"

# --------------------------
# macOS: Ensure Homebrew
# --------------------------
- name: Check if Homebrew is installed (macOS)
  shell: |
    if command -v brew >/dev/null 2>&1; then
      echo "found"
    elif [ -f /opt/homebrew/bin/brew ]; then
      echo "found"
    elif [ -f /usr/local/bin/brew ]; then
      echo "found"
    else
      echo "not found"
    fi
  register: brew_check
  changed_when: false
  become: false
  when: ansible_facts['os_family'] == 'Darwin'

- name: Fail if Homebrew missing (macOS)
  fail:
    msg: |
      Homebrew not found. Install manually:
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      User must have admin privileges.
  when:
    - ansible_facts['os_family'] == 'Darwin'
    - brew_check.stdout == 'not found'

- name: Get brew prefix (macOS)
  shell: |
    if command -v brew >/dev/null 2>&1; then
      brew --prefix
    elif [ -f /opt/homebrew/bin/brew ]; then
      /opt/homebrew/bin/brew --prefix
    elif [ -f /usr/local/bin/brew ]; then
      /usr/local/bin/brew --prefix
    fi
  register: brew_prefix
  changed_when: false
  become: false
  when: ansible_facts['os_family'] == 'Darwin'

- name: Set mkcert paths (macOS)
  set_fact:
    cert_dir: "{{ brew_prefix.stdout }}/etc/ssl/ansible-mkcert"
    mkcert_binary: "{{ brew_prefix.stdout }}/bin/mkcert"
  when: ansible_facts['os_family'] == 'Darwin'

- name: Install mkcert (macOS)
  homebrew:
    name: mkcert
    state: present
  become: false
  when: ansible_facts['os_family'] == 'Darwin'

# --------------------------
# Linux: mkcert via apt
# --------------------------
- name: Install mkcert (Linux)
  apt:
    name: mkcert
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Debian'

# --------------------------
# Certificate directory
# --------------------------
- name: Create certificate directory
  file:
    path: "{{ cert_dir }}"
    state: directory
    mode: "0755"

# --------------------------
# Install local CA
# --------------------------
- name: Create mkcert CA
  command: "{{ mkcert_binary }} -CAROOT {{ cert_dir }}/ca -install"
  environment:
    CAROOT: "{{ cert_dir }}/ca"
  ignore_errors: true

- name: Verify CA installation (macOS)
  debug:
    msg: "CA installation handled by mkcert -install command"
  when: ansible_facts['os_family'] == 'Darwin'

# --------------------------
# SAN list
# --------------------------
- name: Build SAN list
  set_fact:
    mkcert_sans: "{{ base_domains + [magazine, 'api.' ~ magazine] }}"

# --------------------------
# Generate certificate
# --------------------------
- name: Generate certificate
  command: >
    {{ mkcert_binary }}
    -cert-file {{ cert_dir }}/cert.pem
    -key-file {{ cert_dir }}/key.pem
    {{ mkcert_sans | join(' ') }}

- name: Set certificate permissions
  file:
    path: "{{ cert_dir }}/{{ item }}"
    mode: "0644"
  loop:
    - cert.pem
    - key.pem
